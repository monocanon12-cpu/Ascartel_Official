<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inscription • AsCartel</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="auth.css">
</head>
<body>
  <div class="auth-container">
    <div class="auth-box">
      <div class="auth-header">
        <a href="index.html" class="logo">As<span style="color: #f68db5;">C</span></a>
        <h1>Créer un compte</h1>
        <p>Rejoignez AsCartel et profitez d'avantages exclusifs</p>
      </div>

      <form id="registerForm" class="auth-form">
        <div class="form-row">
          <div class="form-group">
            <label for="prenom">Prénom</label>
            <input type="text" id="prenom" name="prenom" required>
            <span class="error-message" id="prenomError"></span>
          </div>

          <div class="form-group">
            <label for="nom">Nom *</label>
            <input type="text" id="nom" name="nom" required>
            <span class="error-message" id="nomError"></span>
          </div>
        </div>

        <div class="form-group">
          <label for="email">Email *</label>
          <input type="email" id="email" name="email" required>
          <span class="error-message" id="emailError"></span>
          <span class="success-message" id="emailSuccess"></span>
        </div>

        <div class="form-group">
          <label for="telephone">Téléphone</label>
          <input type="tel" id="telephone" name="telephone" placeholder="+261 34 00 000 00">
          <span class="error-message" id="telephoneError"></span>
        </div>

        <div class="form-group">
          <label for="password">Mot de passe *</label>
          <div class="password-input">
            <input type="password" id="password" name="password" required>
            <button type="button" class="toggle-password" onclick="togglePassword('password')">
              <i class="far fa-eye"></i>
            </button>
          </div>
          <div class="password-strength" id="passwordStrength">
            <div class="strength-bar"></div>
          </div>
          <span class="error-message" id="passwordError"></span>
          <ul class="password-requirements">
            <li id="req-length"><i class="far fa-circle"></i> Au moins 6 caractères</li>
            <li id="req-letter"><i class="far fa-circle"></i> Une lettre</li>
            <li id="req-number"><i class="far fa-circle"></i> Un chiffre</li>
          </ul>
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirmer le mot de passe *</label>
          <div class="password-input">
            <input type="password" id="confirmPassword" name="confirmPassword" required>
            <button type="button" class="toggle-password" onclick="togglePassword('confirmPassword')">
              <i class="far fa-eye"></i>
            </button>
          </div>
          <span class="error-message" id="confirmPasswordError"></span>
        </div>

        <div class="form-group checkbox-group">
          <label>
            <input type="checkbox" id="acceptTerms" required>
            <span>J'accepte les <a href="cgv.html" target="_blank">conditions générales</a> et la <a href="confidentialite.html" target="_blank">politique de confidentialité</a></span>
          </label>
          <span class="error-message" id="termsError"></span>
        </div>

        <div class="form-group checkbox-group">
          <label>
            <input type="checkbox" id="newsletter">
            <span>Je souhaite recevoir les offres et nouveautés par email</span>
          </label>
        </div>

        <button type="submit" class="auth-button" id="submitBtn">
          <span class="btn-text">Créer mon compte</span>
          <span class="btn-loader" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i>
          </span>
        </button>

        <div class="form-message" id="formMessage"></div>
      </form>

      <div class="auth-footer">
        <p>Vous avez déjà un compte ? <a href="login.html">Se connecter</a></p>
      </div>

      <div class="social-auth">
        <p class="divider"><span>Ou s'inscrire avec</span></p>
        <div class="social-buttons">
          <button class="social-btn google" onclick="signInWithGoogle()">
            <i class="fab fa-google"></i> Google
          </button>
          <button class="social-btn facebook" onclick="signInWithFacebook()">
            <i class="fab fa-facebook-f"></i> Facebook
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script src="firebase-config.js"></script>
  <script src="firebase-auth.js"></script>
  <script>
    const form = document.getElementById('registerForm');
    const submitBtn = document.getElementById('submitBtn');
    const formMessage = document.getElementById('formMessage');

    // Validation temps réel
    document.getElementById('email').addEventListener('blur', validateEmail);
    document.getElementById('password').addEventListener('input', validatePassword);
    document.getElementById('confirmPassword').addEventListener('input', validateConfirmPassword);
    document.getElementById('nom').addEventListener('blur', validateNom);

    function validateEmail() {
      const email = document.getElementById('email').value;
      const emailError = document.getElementById('emailError');
      const emailSuccess = document.getElementById('emailSuccess');
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (!email) {
        emailError.textContent = 'Email requis';
        emailSuccess.textContent = '';
        return false;
      }

      if (!emailRegex.test(email)) {
        emailError.textContent = 'Format email invalide';
        emailSuccess.textContent = '';
        return false;
      }

      emailError.textContent = '';
      emailSuccess.textContent = '✓ Email valide';
      return true;
    }

    function validatePassword() {
      const password = document.getElementById('password').value;
      const passwordError = document.getElementById('passwordError');
      const strengthBar = document.querySelector('.strength-bar');
      
      // Requirements
      const hasLength = password.length >= 6;
      const hasLetter = /[a-zA-Z]/.test(password);
      const hasNumber = /[0-9]/.test(password);

      // Update requirements UI
      updateRequirement('req-length', hasLength);
      updateRequirement('req-letter', hasLetter);
      updateRequirement('req-number', hasNumber);

      // Calculate strength
      let strength = 0;
      if (hasLength) strength++;
      if (hasLetter) strength++;
      if (hasNumber) strength++;
      if (password.length >= 10) strength++;

      // Update strength bar
      strengthBar.style.width = (strength * 25) + '%';
      strengthBar.className = 'strength-bar strength-' + strength;

      if (!password) {
        passwordError.textContent = '';
        return false;
      }

      if (!hasLength) {
        passwordError.textContent = 'Au moins 6 caractères requis';
        return false;
      }

      passwordError.textContent = '';
      return true;
    }

    function validateConfirmPassword() {
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const confirmError = document.getElementById('confirmPasswordError');

      if (!confirmPassword) {
        confirmError.textContent = '';
        return false;
      }

      if (password !== confirmPassword) {
        confirmError.textContent = 'Les mots de passe ne correspondent pas';
        return false;
      }

      confirmError.textContent = '';
      return true;
    }

    function validateNom() {
      const nom = document.getElementById('nom').value;
      const nomError = document.getElementById('nomError');

      if (!nom) {
        nomError.textContent = 'Nom requis';
        return false;
      }

      nomError.textContent = '';
      return true;
    }

    function updateRequirement(id, valid) {
      const el = document.getElementById(id);
      const icon = el.querySelector('i');
      
      if (valid) {
        el.classList.add('valid');
        icon.className = 'fas fa-check-circle';
      } else {
        el.classList.remove('valid');
        icon.className = 'far fa-circle';
      }
    }

    function togglePassword(inputId) {
      const input = document.getElementById(inputId);
      const icon = event.target.closest('button').querySelector('i');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'far fa-eye-slash';
      } else {
        input.type = 'password';
        icon.className = 'far fa-eye';
      }
    }

    // Soumission du formulaire
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validation finale
      if (!validateEmail() || !validatePassword() || !validateConfirmPassword() || !validateNom()) {
        showMessage('Veuillez corriger les erreurs', 'error');
        return;
      }

      if (!document.getElementById('acceptTerms').checked) {
        showMessage('Vous devez accepter les conditions générales', 'error');
        return;
      }

      // Désactiver le bouton
      submitBtn.disabled = true;
      document.querySelector('.btn-text').style.display = 'none';
      document.querySelector('.btn-loader').style.display = 'inline-block';

      try {
        const formData = {
          email: document.getElementById('email').value,
          password: document.getElementById('password').value,
          nom: document.getElementById('nom').value,
          prenom: document.getElementById('prenom').value,
          telephone: document.getElementById('telephone').value
        };

        const response = await fetch(`${CONFIG.apiUrl}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
          // Sauvegarder le token
          localStorage.setItem('ascartel_token', data.token);
          localStorage.setItem('ascartel_user', JSON.stringify(data.user));

          showMessage('✅ Inscription réussie ! Redirection...', 'success');
          
          setTimeout(() => {
            window.location.href = 'dashboard-client.html';
          }, 1500);
        } else {
          showMessage(data.error || 'Erreur lors de l\'inscription', 'error');
          submitBtn.disabled = false;
          document.querySelector('.btn-text').style.display = 'inline-block';
          document.querySelector('.btn-loader').style.display = 'none';
        }
      } catch (error) {
        console.error('Erreur:', error);
        showMessage('Erreur de connexion au serveur', 'error');
        submitBtn.disabled = false;
        document.querySelector('.btn-text').style.display = 'inline-block';
        document.querySelector('.btn-loader').style.display = 'none';
      }
    });

    function showMessage(message, type) {
      formMessage.textContent = message;
      formMessage.className = 'form-message ' + type;
      formMessage.style.display = 'block';
    }
  </script>
</body>
</html>
